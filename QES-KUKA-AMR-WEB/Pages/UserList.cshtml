@page
@model QES_KUKA_AMR_WEB.Pages.UserListModel
@{
    ViewData["Title"] = "User Role List";
    Layout = "_DashboardLayout";
}

@{
    string SortClass(string column)
    {
        if (!string.Equals(Model.SortColumn, column, StringComparison.OrdinalIgnoreCase))
        {
            return "sort-icon";
        }

        return Model.SortDirection.Equals("desc", StringComparison.OrdinalIgnoreCase)
            ? "sort-icon desc"
            : "sort-icon asc";
    }

    string NextDirection(string column) =>
        string.Equals(Model.SortColumn, column, StringComparison.OrdinalIgnoreCase) &&
        Model.SortDirection.Equals("asc", StringComparison.OrdinalIgnoreCase)
            ? "desc"
            : "asc";
}

<div class="content-header mb-3">
    <h2 class="mb-1">User Role List Management</h2>
    <p class="text-muted mb-0" style="font-size: 14px;">Manage and synchronize User Role configurations</p>
</div>

@if (!string.IsNullOrEmpty(Model.StatusMessage))
{
    var alertClass = Model.StatusType switch
    {
        "success" => "alert-success",
        "warning" => "alert-warning",
        "danger" => "alert-danger",
        _ => "alert-info"
    };

    <div id="statusAlert" class="alert @alertClass alert-dismissible fade show" role="alert">
        @Model.StatusMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="d-flex justify-content-end mb-3">
    <form method="post" asp-page-handler="Sync" class="mb-0">
        <input type="hidden" name="SortColumn" value="@Model.SortColumn" />
        <input type="hidden" name="SortDirection" value="@Model.SortDirection" />
        <input type="hidden" name="CurrentPage" value="@Model.CurrentPage" />
        <input type="hidden" name="PageSize" value="@Model.PageSize" />
        <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
        <button type="submit" class="btn-sync">
            <span class="sync-icon">&#x21BB;</span>
            Sync User Role List
        </button>
    </form>
</div>

<!-- Filter Section -->
<div class="filter-section mb-3">
    <form id="searchForm" method="get" class="d-flex gap-2 align-items-center flex-wrap">
        <input type="hidden" name="SortColumn" value="@Model.SortColumn" />
        <input type="hidden" name="SortDirection" value="@Model.SortDirection" />
        <input type="hidden" name="CurrentPage" value="1" />
        <input type="hidden" name="PageSize" value="@Model.PageSize" />

        <div class="search-group flex-grow-1">
            <input type="text"
                   id="searchInput"
                   name="SearchTerm"
                   value="@Model.SearchTerm"
                   placeholder="Search by Username, or role Name..."
                   class="search-input" />
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.SearchTerm))
        {
            <a asp-page="./UserList"
               asp-route-SortColumn="@Model.SortColumn"
               asp-route-SortDirection="@Model.SortDirection"
               asp-route-PageSize="@Model.PageSize"
               class="btn-clear">
                <span>&#10005;</span> Clear
            </a>
        }
    </form>

    @if (!string.IsNullOrWhiteSpace(Model.SearchTerm))
    {
        <div class="filter-indicator mt-2">
            <span class="badge bg-info">
                <span>&#128269;</span> Filtering: "@Model.SearchTerm"
            </span>
        </div>
    }
</div>

<div class="table-container table-scroll-workflow">
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>
                        <a asp-page="./UserList"
                           asp-route-SortColumn="Username"
                           asp-route-SortDirection="@NextDirection("Username")"
                           asp-route-CurrentPage="@Model.CurrentPage"
                           asp-route-PageSize="@Model.PageSize"
                           asp-route-SearchTerm="@Model.SearchTerm"
                           class="sortable-column">
                            Username <span class="@SortClass("Username")"></span>
                        </a>
                    </th>
                    <th>
                        <a asp-page="./UserList"
                           asp-route-SortColumn="Role"
                           asp-route-SortDirection="@NextDirection("Role")"
                           asp-route-CurrentPage="@Model.CurrentPage"
                           asp-route-PageSize="@Model.PageSize"
                           asp-route-SearchTerm="@Model.SearchTerm"
                           class="sortable-column">
                            Role <span class="@SortClass("Role")"></span>
                        </a>
                    </th>
                    <th>
                        <a asp-page="./UserList"
                           asp-route-SortColumn="LastUpdateTime"
                           asp-route-SortDirection="@NextDirection("LastUpdateTime")"
                           asp-route-CurrentPage="@Model.CurrentPage"
                           asp-route-PageSize="@Model.PageSize"
                           asp-route-SearchTerm="@Model.SearchTerm"
                           class="sortable-column">
                            Last Update Time <span class="@SortClass("LastUpdateTime")"></span>
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                @if (Model.TotalRecords == 0)
                {
                    <tr>
                        <td colspan="9" class="text-center text-muted">No User Role records found.</td>
                    </tr>
                }
                else
                {
                    foreach (var user in Model.Users)
                    {
                        <tr>
                            <td>@user.Username</td>
                            <td>@string.Join(", ", user.RoleName)</td>
                            <td>@user.LastUpdateTime</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination Footer -->
    @if (Model.TotalRecords > 0)
    {
        <div class="pagination-section">
            <div class="pagination-info">
                <span class="page-info">
                    Showing @Model.DisplayStart-@Model.DisplayEnd of @Model.TotalRecords records
                </span>
            </div>

            <div class="pagination-controls">
                @if (Model.CurrentPage > 1)
                {
                    <a asp-page="./UserList"
                       asp-route-SortColumn="@Model.SortColumn"
                       asp-route-SortDirection="@Model.SortDirection"
                       asp-route-CurrentPage="@(Model.CurrentPage - 1)"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       class="btn-page">
                        &laquo; Previous
                    </a>
                }
                else
                {
                    <button class="btn-page" disabled>&laquo; Previous</button>
                }

                <div class="page-numbers">
                    @{
                        int startPage = Math.Max(1, Model.CurrentPage - 2);
                        int endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);

                        if (startPage > 1)
                        {
                            <a asp-page="./UserList" asp-route-SortColumn="@Model.SortColumn" asp-route-SortDirection="@Model.SortDirection" asp-route-CurrentPage="1" asp-route-PageSize="@Model.PageSize" asp-route-SearchTerm="@Model.SearchTerm" class="btn-page">1</a>
                            if (startPage > 2)
                            {
                                <span class="page-ellipsis">...</span>
                            }
                        }

                        for (int i = startPage; i <= endPage; i++)
                        {
                            if (i == Model.CurrentPage)
                            {
                                <button class="btn-page active">@i</button>
                            }
                            else
                            {
                                <a asp-page="./UserList" asp-route-SortColumn="@Model.SortColumn" asp-route-SortDirection="@Model.SortDirection" asp-route-CurrentPage="@i" asp-route-PageSize="@Model.PageSize" asp-route-SearchTerm="@Model.SearchTerm" class="btn-page">@i</a>
                            }
                        }

                        if (endPage < Model.TotalPages)
                        {
                            if (endPage < Model.TotalPages - 1)
                            {
                                <span class="page-ellipsis">...</span>
                            }
                            <a asp-page="./UserList" asp-route-SortColumn="@Model.SortColumn" asp-route-SortDirection="@Model.SortDirection" asp-route-CurrentPage="@Model.TotalPages" asp-route-PageSize="@Model.PageSize" asp-route-SearchTerm="@Model.SearchTerm" class="btn-page">@Model.TotalPages</a>
                        }
                    }
                </div>

                @if (Model.CurrentPage < Model.TotalPages)
                {
                    <a asp-page="./UserList" asp-route-SortColumn="@Model.SortColumn" asp-route-SortDirection="@Model.SortDirection" asp-route-CurrentPage="@(Model.CurrentPage + 1)" asp-route-PageSize="@Model.PageSize" asp-route-SearchTerm="@Model.SearchTerm" class="btn-page">
                        Next &raquo;
                    </a>
                }
                else
                {
                    <button class="btn-page" disabled>Next &raquo;</button>
                }
            </div>

            <div class="page-size-selector">
                <form method="get" class="d-inline">
                    <input type="hidden" name="SortColumn" value="@Model.SortColumn" />
                    <input type="hidden" name="SortDirection" value="@Model.SortDirection" />
                    <input type="hidden" name="CurrentPage" value="1" />
                    <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
                    <label class="items-label">Items per page:</label>
                    <select name="PageSize" class="items-per-page" onchange="this.form.submit()">
                        <option value="10" selected="@(Model.PageSize == 10)">10</option>
                        <option value="20" selected="@(Model.PageSize == 20)">20</option>
                        <option value="50" selected="@(Model.PageSize == 50)">50</option>
                        <option value="100" selected="@(Model.PageSize == 100)">100</option>
                    </select>
                </form>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const statusAlert = document.getElementById('statusAlert');
            if (statusAlert) {
                setTimeout(function() {
                    const bsAlert = new bootstrap.Alert(statusAlert);
                    bsAlert.close();
                }, 5000);
            }

            const searchInput = document.getElementById('searchInput');
            const searchForm = document.getElementById('searchForm');
            let searchDebounceTimer;

            if (searchInput && searchForm) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchDebounceTimer);
                    searchDebounceTimer = setTimeout(() => {
                        searchForm.submit();
                    }, 300);
                });

                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        clearTimeout(searchDebounceTimer);
                        searchForm.submit();
                    }
                });
            }
        });
    </script>
}
