@page
@model QES_KUKA_AMR_WEB.Pages.WorkflowManagementModel
@{
    ViewData["Title"] = "Workflow Management";
    Layout = "_DashboardLayout";
}

@{
    string SortClass(string column)
    {
        if (!string.Equals(Model.SortColumn, column, StringComparison.OrdinalIgnoreCase))
        {
            return "sort-icon";
        }

        return Model.SortDirection.Equals("desc", StringComparison.OrdinalIgnoreCase)
            ? "sort-icon desc"
            : "sort-icon asc";
    }

    string NextDirection(string column) =>
        string.Equals(Model.SortColumn, column, StringComparison.OrdinalIgnoreCase) &&
        Model.SortDirection.Equals("asc", StringComparison.OrdinalIgnoreCase)
            ? "desc"
            : "asc";
}

<div class="content-header d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
        <h2 class="mb-1">Workflow Management</h2>
        <p class="text-muted mb-0" style="font-size: 14px;">Manage and synchronize workflow configurations</p>
    </div>
    <form method="post" asp-page-handler="Sync" class="mb-0">
        <input type="hidden" name="SortColumn" value="@Model.SortColumn" />
        <input type="hidden" name="SortDirection" value="@Model.SortDirection" />
        <input type="hidden" name="CurrentPage" value="@Model.CurrentPage" />
        <input type="hidden" name="PageSize" value="@Model.PageSize" />
        <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
        <button type="submit" class="btn-sync">
            <span class="sync-icon">&#x21BB;</span>
            Sync Workflows
        </button>
    </form>
</div>

<!-- Filter Section -->
<div class="filter-section mb-3">
    <form id="searchForm" method="get" class="d-flex gap-2 align-items-center flex-wrap">
        <input type="hidden" name="SortColumn" value="@Model.SortColumn" />
        <input type="hidden" name="SortDirection" value="@Model.SortDirection" />
        <input type="hidden" name="CurrentPage" value="1" />
        <input type="hidden" name="PageSize" value="@Model.PageSize" />

        <div class="search-group flex-grow-1">
            <input type="text"
                   id="searchInput"
                   name="SearchTerm"
                   value="@Model.SearchTerm"
                   placeholder="Search by name, number, external code, or layout code..."
                   class="search-input" />
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.SearchTerm))
        {
            <a asp-page="./WorkflowManagement"
               asp-route-SortColumn="@Model.SortColumn"
               asp-route-SortDirection="@Model.SortDirection"
               asp-route-PageSize="@Model.PageSize"
               class="btn-clear">
                <span>&#10005;</span> Clear
            </a>
        }
    </form>

    @if (!string.IsNullOrWhiteSpace(Model.SearchTerm))
    {
        <div class="filter-indicator mt-2">
            <span class="badge bg-info">
                <span>&#128269;</span> Filtering: "@Model.SearchTerm"
            </span>
        </div>
    }
</div>

@if (!string.IsNullOrEmpty(Model.StatusMessage))
{
    var alertClass = Model.StatusType switch
    {
        "success" => "alert-success",
        "warning" => "alert-warning",
        "danger" => "alert-danger",
        _ => "alert-info"
    };

    <div id="statusAlert" class="alert @alertClass alert-dismissible fade show" role="alert">
        @Model.StatusMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="table-container table-scroll-workflow">
    <div class="table-responsive">
        <table class="data-table">
            <thead>
            <tr>
                <th>
                    <a asp-page="./WorkflowManagement"
                       asp-route-SortColumn="Id"
                       asp-route-SortDirection="@NextDirection("Id")"
                       asp-route-CurrentPage="@Model.CurrentPage"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       class="sortable-column">
                        ID <span class="@SortClass("Id")"></span>
                    </a>
                </th>
                <th>
                    <a asp-page="./WorkflowManagement"
                       asp-route-SortColumn="Name"
                       asp-route-SortDirection="@NextDirection("Name")"
                       asp-route-CurrentPage="@Model.CurrentPage"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       class="sortable-column">
                        Name <span class="@SortClass("Name")"></span>
                    </a>
                </th>
                <th>
                    <a asp-page="./WorkflowManagement"
                       asp-route-SortColumn="Number"
                       asp-route-SortDirection="@NextDirection("Number")"
                       asp-route-CurrentPage="@Model.CurrentPage"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       class="sortable-column">
                        Number <span class="@SortClass("Number")"></span>
                    </a>
                </th>
                <th>
                    <a asp-page="./WorkflowManagement"
                       asp-route-SortColumn="ExternalCode"
                       asp-route-SortDirection="@NextDirection("ExternalCode")"
                       asp-route-CurrentPage="@Model.CurrentPage"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       class="sortable-column">
                        External Code <span class="@SortClass("ExternalCode")"></span>
                    </a>
                </th>
                <th>
                    <a asp-page="./WorkflowManagement"
                       asp-route-SortColumn="Status"
                       asp-route-SortDirection="@NextDirection("Status")"
                       asp-route-CurrentPage="@Model.CurrentPage"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       class="sortable-column">
                        Status <span class="@SortClass("Status")"></span>
                    </a>
                </th>
                <th>
                    <a asp-page="./WorkflowManagement"
                       asp-route-SortColumn="LayoutCode"
                       asp-route-SortDirection="@NextDirection("LayoutCode")"
                       asp-route-CurrentPage="@Model.CurrentPage"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       class="sortable-column">
                        Layout Code <span class="@SortClass("LayoutCode")"></span>
                    </a>
                </th>
            </tr>
            </thead>
            <tbody>
            @if (Model.TotalRecords == 0)
            {
                <tr>
                    <td colspan="6" class="text-center py-4">
                        @if (!string.IsNullOrWhiteSpace(Model.SearchTerm))
                        {
                            <span>No workflows match your search criteria. Try a different search term or <a asp-page="./WorkflowManagement" asp-route-SortColumn="@Model.SortColumn" asp-route-SortDirection="@Model.SortDirection" asp-route-PageSize="@Model.PageSize">clear the filter</a>.</span>
                        }
                        else
                        {
                            <span>No workflows available. Click "Sync Workflows" to import the latest data.</span>
                        }
                    </td>
                </tr>
            }
            else
            {
                foreach (var workflow in Model.Workflows)
                {
                    <tr>
                        <td>@workflow.Id</td>
                        <td>@workflow.Name</td>
                        <td>@workflow.Number</td>
                        <td>@workflow.ExternalCode</td>
                        <td>@(workflow.Status == 1 ? "Enabled" : "Disabled")</td>
                        <td>@workflow.LayoutCode</td>
                    </tr>
                }
            }
            </tbody>
        </table>
    </div>

    <!-- Pagination Footer -->
    @if (Model.TotalRecords > 0)
    {
        <div class="pagination-section">
            <div class="pagination-info">
                <span class="page-info">
                    Showing @Model.DisplayStart-@Model.DisplayEnd of @Model.TotalRecords records
                </span>
            </div>

            <div class="pagination-controls">
                <!-- Previous Button -->
                @if (Model.CurrentPage > 1)
                {
                    <a asp-page="./WorkflowManagement"
                       asp-route-SortColumn="@Model.SortColumn"
                       asp-route-SortDirection="@Model.SortDirection"
                       asp-route-CurrentPage="@(Model.CurrentPage - 1)"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       class="btn-page">
                        &laquo; Previous
                    </a>
                }
                else
                {
                    <button class="btn-page" disabled>&laquo; Previous</button>
                }

                <!-- Page Numbers -->
                <div class="page-numbers">
                    @{
                        int startPage = Math.Max(1, Model.CurrentPage - 2);
                        int endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);

                        if (startPage > 1)
                        {
                            <a asp-page="./WorkflowManagement"
                               asp-route-SortColumn="@Model.SortColumn"
                               asp-route-SortDirection="@Model.SortDirection"
                               asp-route-CurrentPage="1"
                               asp-route-PageSize="@Model.PageSize"
                               asp-route-SearchTerm="@Model.SearchTerm"
                               class="btn-page">1</a>
                            if (startPage > 2)
                            {
                                <span class="page-ellipsis">...</span>
                            }
                        }

                        for (int i = startPage; i <= endPage; i++)
                        {
                            if (i == Model.CurrentPage)
                            {
                                <button class="btn-page active">@i</button>
                            }
                            else
                            {
                                <a asp-page="./WorkflowManagement"
                                   asp-route-SortColumn="@Model.SortColumn"
                                   asp-route-SortDirection="@Model.SortDirection"
                                   asp-route-CurrentPage="@i"
                                   asp-route-PageSize="@Model.PageSize"
                                   asp-route-SearchTerm="@Model.SearchTerm"
                                   class="btn-page">@i</a>
                            }
                        }

                        if (endPage < Model.TotalPages)
                        {
                            if (endPage < Model.TotalPages - 1)
                            {
                                <span class="page-ellipsis">...</span>
                            }
                            <a asp-page="./WorkflowManagement"
                               asp-route-SortColumn="@Model.SortColumn"
                               asp-route-SortDirection="@Model.SortDirection"
                               asp-route-CurrentPage="@Model.TotalPages"
                               asp-route-PageSize="@Model.PageSize"
                               asp-route-SearchTerm="@Model.SearchTerm"
                               class="btn-page">@Model.TotalPages</a>
                        }
                    }
                </div>

                <!-- Next Button -->
                @if (Model.CurrentPage < Model.TotalPages)
                {
                    <a asp-page="./WorkflowManagement"
                       asp-route-SortColumn="@Model.SortColumn"
                       asp-route-SortDirection="@Model.SortDirection"
                       asp-route-CurrentPage="@(Model.CurrentPage + 1)"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       class="btn-page">
                        Next &raquo;
                    </a>
                }
                else
                {
                    <button class="btn-page" disabled>Next &raquo;</button>
                }
            </div>

            <div class="page-size-selector">
                <form method="get" class="d-inline">
                    <input type="hidden" name="SortColumn" value="@Model.SortColumn" />
                    <input type="hidden" name="SortDirection" value="@Model.SortDirection" />
                    <input type="hidden" name="CurrentPage" value="1" />
                    <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
                    <label class="items-label">Items per page:</label>
                    <select name="PageSize" class="items-per-page" onchange="this.form.submit()">
                        <option value="10" selected="@(Model.PageSize == 10)">10</option>
                        <option value="20" selected="@(Model.PageSize == 20)">20</option>
                        <option value="50" selected="@(Model.PageSize == 50)">50</option>
                        <option value="100" selected="@(Model.PageSize == 100)">100</option>
                    </select>
                </form>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Auto-dismiss status alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const statusAlert = document.getElementById('statusAlert');
            if (statusAlert) {
                setTimeout(function() {
                    const bsAlert = new bootstrap.Alert(statusAlert);
                    bsAlert.close();
                }, 5000); // 5 seconds
            }

            // Auto-search functionality
            const searchInput = document.getElementById('searchInput');
            const searchForm = document.getElementById('searchForm');
            let searchDebounceTimer;

            if (searchInput && searchForm) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchDebounceTimer);
                    searchDebounceTimer = setTimeout(() => {
                        searchForm.submit();
                    }, 300); // 300ms delay for debouncing
                });

                // Allow instant search on Enter key
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        clearTimeout(searchDebounceTimer);
                        searchForm.submit();
                    }
                });
            }
        });
    </script>
}
