@page
@model QES_KUKA_AMR_WEB.Pages.MissionHistoryModel
@{
    ViewData["Title"] = "Mission History";
    Layout = "_DashboardLayout";
}

@{
    string SortClass(string column)
    {
        if (!string.Equals(Model.SortColumn, column, StringComparison.OrdinalIgnoreCase))
        {
            return "sort-icon";
        }

        return Model.SortDirection.Equals("desc", StringComparison.OrdinalIgnoreCase)
            ? "sort-icon desc"
            : "sort-icon asc";
    }

    string NextDirection(string column) =>
        string.Equals(Model.SortColumn, column, StringComparison.OrdinalIgnoreCase) &&
        Model.SortDirection.Equals("asc", StringComparison.OrdinalIgnoreCase)
            ? "desc"
            : "asc";
}

<div class="content-header d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
        <h2 class="mb-1">Mission History</h2>
        <p class="text-muted mb-0" style="font-size: 14px;">View completed, failed, and cancelled missions.</p>
    </div>
    <form method="post" asp-page-handler="Clear" onsubmit="return confirm('Are you sure you want to clear all mission history?');" class="mb-0">
        <input type="hidden" name="SortColumn" value="@Model.SortColumn" />
        <input type="hidden" name="SortDirection" value="@Model.SortDirection" />
        <input type="hidden" name="PageSize" value="@Model.PageSize" />
        <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
        <input type="hidden" name="StatusFilter" value="@Model.StatusFilter" />
        <button type="submit" class="btn btn-outline-danger">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem;">
                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
            </svg>
            Clear All History
        </button>
    </form>
</div>

<!-- Stats Card -->
<div class="stats-card mb-3">
    <div>
        <strong>Total Records:</strong> @Model.TotalRecords / @Model.MaxRecords
    </div>
    <div>
        @{
            var percentage = Model.MaxRecords > 0 ? (Model.TotalRecords * 100.0 / Model.MaxRecords) : 0;
            var progressClass = percentage >= 90 ? "bg-danger" : percentage >= 70 ? "bg-warning" : "bg-success";
        }
        <div class="progress" style="width: 200px; height: 20px;">
            <div class="progress-bar @progressClass" role="progressbar" style="width: @percentage%;" aria-valuenow="@Model.TotalRecords" aria-valuemin="0" aria-valuemax="@Model.MaxRecords">
                @percentage.ToString("F1")%
            </div>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="filter-section mb-3">
    <form id="searchForm" method="get" class="d-flex gap-2 align-items-center flex-wrap">
        <input type="hidden" name="SortColumn" value="@Model.SortColumn" />
        <input type="hidden" name="SortDirection" value="@Model.SortDirection" />
        <input type="hidden" name="CurrentPage" value="1" />
        <input type="hidden" name="PageSize" value="@Model.PageSize" />

        <div class="search-group flex-grow-1">
            <input type="text"
                   id="searchInput"
                   name="SearchTerm"
                   value="@Model.SearchTerm"
                   placeholder="Search by mission code, request ID, or workflow name..."
                   class="search-input" />
        </div>

        <select id="statusFilter" name="StatusFilter" class="form-select" style="width: auto; min-width: 150px;">
            <option value="">All Status</option>
            <option value="Complete" selected="@(Model.StatusFilter == "Complete")">Complete</option>
            <option value="Failed" selected="@(Model.StatusFilter == "Failed")">Failed</option>
            <option value="Cancelled" selected="@(Model.StatusFilter == "Cancelled")">Cancelled</option>
        </select>

        @if (!string.IsNullOrWhiteSpace(Model.SearchTerm) || !string.IsNullOrWhiteSpace(Model.StatusFilter))
        {
            <a asp-page="./MissionHistory"
               asp-route-SortColumn="@Model.SortColumn"
               asp-route-SortDirection="@Model.SortDirection"
               asp-route-PageSize="@Model.PageSize"
               class="btn-clear">
                <span>&#10005;</span> Clear
            </a>
        }
    </form>

    @if (!string.IsNullOrWhiteSpace(Model.SearchTerm) || !string.IsNullOrWhiteSpace(Model.StatusFilter))
    {
        <div class="filter-indicator mt-2">
            @if (!string.IsNullOrWhiteSpace(Model.SearchTerm))
            {
                <span class="badge bg-info me-1">
                    <span>&#128269;</span> Search: "@Model.SearchTerm"
                </span>
            }
            @if (!string.IsNullOrWhiteSpace(Model.StatusFilter))
            {
                <span class="badge bg-info">
                    <span>&#128190;</span> Status: @Model.StatusFilter
                </span>
            }
        </div>
    }
</div>

@if (!string.IsNullOrEmpty(Model.StatusMessage))
{
    var alertClass = Model.StatusType switch
    {
        "success" => "alert-success",
        "warning" => "alert-warning",
        "danger" => "alert-danger",
        _ => "alert-info"
    };

    <div id="statusAlert" class="alert @alertClass alert-dismissible fade show" role="alert">
        @Model.StatusMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="table-container table-scroll-history">
    <div class="table-responsive">
        <table class="data-table">
            <thead>
            <tr>
                <th>
                    <a asp-page="./MissionHistory"
                       asp-route-SortColumn="Id"
                       asp-route-SortDirection="@NextDirection("Id")"
                       asp-route-CurrentPage="@Model.CurrentPage"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       asp-route-StatusFilter="@Model.StatusFilter"
                       class="sortable-column">
                        ID <span class="@SortClass("Id")"></span>
                    </a>
                </th>
                <th>
                    <a asp-page="./MissionHistory"
                       asp-route-SortColumn="MissionCode"
                       asp-route-SortDirection="@NextDirection("MissionCode")"
                       asp-route-CurrentPage="@Model.CurrentPage"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       asp-route-StatusFilter="@Model.StatusFilter"
                       class="sortable-column">
                        Mission Code <span class="@SortClass("MissionCode")"></span>
                    </a>
                </th>
                <th>
                    <a asp-page="./MissionHistory"
                       asp-route-SortColumn="RequestId"
                       asp-route-SortDirection="@NextDirection("RequestId")"
                       asp-route-CurrentPage="@Model.CurrentPage"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       asp-route-StatusFilter="@Model.StatusFilter"
                       class="sortable-column">
                        Request ID <span class="@SortClass("RequestId")"></span>
                    </a>
                </th>
                <th>
                    <a asp-page="./MissionHistory"
                       asp-route-SortColumn="WorkflowName"
                       asp-route-SortDirection="@NextDirection("WorkflowName")"
                       asp-route-CurrentPage="@Model.CurrentPage"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       asp-route-StatusFilter="@Model.StatusFilter"
                       class="sortable-column">
                        Mission Name <span class="@SortClass("WorkflowName")"></span>
                    </a>
                </th>
                <th>
                    <a asp-page="./MissionHistory"
                       asp-route-SortColumn="MissionType"
                       asp-route-SortDirection="@NextDirection("MissionType")"
                       asp-route-CurrentPage="@Model.CurrentPage"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       asp-route-StatusFilter="@Model.StatusFilter"
                       class="sortable-column">
                        Type <span class="@SortClass("MissionType")"></span>
                    </a>
                </th>
                <th>
                    <a asp-page="./MissionHistory"
                       asp-route-SortColumn="Status"
                       asp-route-SortDirection="@NextDirection("Status")"
                       asp-route-CurrentPage="@Model.CurrentPage"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       asp-route-StatusFilter="@Model.StatusFilter"
                       class="sortable-column">
                        Status <span class="@SortClass("Status")"></span>
                    </a>
                </th>
                <th>
                    <a asp-page="./MissionHistory"
                       asp-route-SortColumn="CreatedDate"
                       asp-route-SortDirection="@NextDirection("CreatedDate")"
                       asp-route-CurrentPage="@Model.CurrentPage"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       asp-route-StatusFilter="@Model.StatusFilter"
                       class="sortable-column">
                        Date/Time <span class="@SortClass("CreatedDate")"></span>
                    </a>
                </th>
            </tr>
            </thead>
            <tbody>
            @if (Model.TotalRecords == 0)
            {
                <tr>
                    <td colspan="7" class="text-center py-4">
                        @if (!string.IsNullOrWhiteSpace(Model.SearchTerm) || !string.IsNullOrWhiteSpace(Model.StatusFilter))
                        {
                            <span>No missions match your search criteria. Try a different search term or <a asp-page="./MissionHistory" asp-route-SortColumn="@Model.SortColumn" asp-route-SortDirection="@Model.SortDirection" asp-route-PageSize="@Model.PageSize">clear the filter</a>.</span>
                        }
                        else
                        {
                            <div class="py-4">
                                <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">ðŸ“‹</div>
                                <h5>No Mission History</h5>
                                <p class="text-muted">Mission history will appear here once workflows or custom missions are triggered and completed.</p>
                                <a class="btn btn-primary me-2" href="/WorkflowTrigger">Trigger Workflows</a>
                                <a class="btn btn-outline-primary" href="/SavedCustomMissions">Trigger Custom Missions</a>
                            </div>
                        }
                    </td>
                </tr>
            }
            else
            {
                foreach (var mission in Model.Missions)
                {
                    var statusClass = mission.Status.ToLower() switch
                    {
                        "complete" => "status-complete",
                        "completed" => "status-complete",
                        "failed" => "status-failed",
                        "cancelled" => "status-cancelled",
                        _ => ""
                    };

                    var missionTypeClass = mission.MissionType == "Custom" ? "badge bg-info" : "badge bg-primary";

                    <tr>
                        <td>@mission.Id</td>
                        <td><code>@mission.MissionCode</code></td>
                        <td><code>@mission.RequestId</code></td>
                        <td>@(mission.WorkflowName ?? mission.MissionCode)</td>
                        <td><span class="@missionTypeClass">@(mission.MissionType ?? "Workflow")</span></td>
                        <td><span class="status-badge @statusClass">@mission.Status</span></td>
                        <td>@mission.CreatedDate.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</td>
                    </tr>
                }
            }
            </tbody>
        </table>
    </div>

    <!-- Pagination Footer -->
    @if (Model.TotalRecords > 0)
    {
        <div class="pagination-section">
            <div class="pagination-info">
                <span class="page-info">
                    Showing @Model.DisplayStart-@Model.DisplayEnd of @Model.TotalRecords records
                </span>
            </div>

            <div class="pagination-controls">
                <!-- Previous Button -->
                @if (Model.CurrentPage > 1)
                {
                    <a asp-page="./MissionHistory"
                       asp-route-SortColumn="@Model.SortColumn"
                       asp-route-SortDirection="@Model.SortDirection"
                       asp-route-CurrentPage="@(Model.CurrentPage - 1)"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       asp-route-StatusFilter="@Model.StatusFilter"
                       class="btn-page">
                        &laquo; Previous
                    </a>
                }
                else
                {
                    <button class="btn-page" disabled>&laquo; Previous</button>
                }

                <!-- Page Numbers -->
                <div class="page-numbers">
                    @{
                        int startPage = Math.Max(1, Model.CurrentPage - 2);
                        int endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);

                        if (startPage > 1)
                        {
                            <a asp-page="./MissionHistory"
                               asp-route-SortColumn="@Model.SortColumn"
                               asp-route-SortDirection="@Model.SortDirection"
                               asp-route-CurrentPage="1"
                               asp-route-PageSize="@Model.PageSize"
                               asp-route-SearchTerm="@Model.SearchTerm"
                               asp-route-StatusFilter="@Model.StatusFilter"
                               class="btn-page">1</a>
                            if (startPage > 2)
                            {
                                <span class="page-ellipsis">...</span>
                            }
                        }

                        for (int i = startPage; i <= endPage; i++)
                        {
                            if (i == Model.CurrentPage)
                            {
                                <button class="btn-page active">@i</button>
                            }
                            else
                            {
                                <a asp-page="./MissionHistory"
                                   asp-route-SortColumn="@Model.SortColumn"
                                   asp-route-SortDirection="@Model.SortDirection"
                                   asp-route-CurrentPage="@i"
                                   asp-route-PageSize="@Model.PageSize"
                                   asp-route-SearchTerm="@Model.SearchTerm"
                                   asp-route-StatusFilter="@Model.StatusFilter"
                                   class="btn-page">@i</a>
                            }
                        }

                        if (endPage < Model.TotalPages)
                        {
                            if (endPage < Model.TotalPages - 1)
                            {
                                <span class="page-ellipsis">...</span>
                            }
                            <a asp-page="./MissionHistory"
                               asp-route-SortColumn="@Model.SortColumn"
                               asp-route-SortDirection="@Model.SortDirection"
                               asp-route-CurrentPage="@Model.TotalPages"
                               asp-route-PageSize="@Model.PageSize"
                               asp-route-SearchTerm="@Model.SearchTerm"
                               asp-route-StatusFilter="@Model.StatusFilter"
                               class="btn-page">@Model.TotalPages</a>
                        }
                    }
                </div>

                <!-- Next Button -->
                @if (Model.CurrentPage < Model.TotalPages)
                {
                    <a asp-page="./MissionHistory"
                       asp-route-SortColumn="@Model.SortColumn"
                       asp-route-SortDirection="@Model.SortDirection"
                       asp-route-CurrentPage="@(Model.CurrentPage + 1)"
                       asp-route-PageSize="@Model.PageSize"
                       asp-route-SearchTerm="@Model.SearchTerm"
                       asp-route-StatusFilter="@Model.StatusFilter"
                       class="btn-page">
                        Next &raquo;
                    </a>
                }
                else
                {
                    <button class="btn-page" disabled>Next &raquo;</button>
                }
            </div>

            <div class="page-size-selector">
                <form method="get" class="d-inline">
                    <input type="hidden" name="SortColumn" value="@Model.SortColumn" />
                    <input type="hidden" name="SortDirection" value="@Model.SortDirection" />
                    <input type="hidden" name="CurrentPage" value="1" />
                    <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
                    <input type="hidden" name="StatusFilter" value="@Model.StatusFilter" />
                    <label class="items-label">Items per page:</label>
                    <select name="PageSize" class="items-per-page" onchange="this.form.submit()">
                        <option value="10" selected="@(Model.PageSize == 10)">10</option>
                        <option value="20" selected="@(Model.PageSize == 20)">20</option>
                        <option value="50" selected="@(Model.PageSize == 50)">50</option>
                        <option value="100" selected="@(Model.PageSize == 100)">100</option>
                    </select>
                </form>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Auto-dismiss status alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const statusAlert = document.getElementById('statusAlert');
            if (statusAlert) {
                setTimeout(function() {
                    const bsAlert = new bootstrap.Alert(statusAlert);
                    bsAlert.close();
                }, 5000);
            }

            // Auto-search functionality
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const searchForm = document.getElementById('searchForm');
            let searchDebounceTimer;

            if (searchInput && searchForm) {
                // Auto-search on text input
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchDebounceTimer);
                    searchDebounceTimer = setTimeout(() => {
                        searchForm.submit();
                    }, 300); // 300ms delay for debouncing
                });

                // Allow instant search on Enter key
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        clearTimeout(searchDebounceTimer);
                        searchForm.submit();
                    }
                });
            }

            // Auto-search on status filter change
            if (statusFilter && searchForm) {
                statusFilter.addEventListener('change', function() {
                    searchForm.submit();
                });
            }
        });
    </script>
}
